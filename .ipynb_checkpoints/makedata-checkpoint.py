import json
import os
from tqdm import tqdm
from openai import OpenAI

def get_openai_response(prompt, api_key, model_name):
    client = OpenAI(
        api_key=api_key,
        base_url="https://api.wlai.vip/v1/"
    )

    content = [{"type": "text", "text": prompt}]

    try:
        chat_completion = client.chat.completions.create(
            messages=[{
                "role": "user",
                "content": content
            }],
            model=model_name
        )
        return chat_completion.choices[0].message.content
    except Exception as e:
        return f"Error: {str(e)}"

def is_valid_response(response):
    """检查响应是否为有效的分类结果"""
    valid_responses = ["静态攻略", "地图上规划", "静态攻略, 地图上规划"]
    return response.strip() in valid_responses

def process_queries(querys, api_key, model_name, output_file):
    """处理查询列表并生成数据"""
    
    # 确保输出目录存在
    os.makedirs(os.path.dirname(output_file), exist_ok=True)
    
    # 打开文件用于追加写入
    with open(output_file, 'w', encoding='utf-8') as f:
        # 使用tqdm显示进度条
        for query in tqdm(querys, desc="处理查询"):
            # 构建prompt
            prompt = f"""你是一个旅游专家，现在用户有一个旅游相关的问题，请你判断这个问题属于以下哪个类别：静态攻略，地图上规划。
静态攻略指的是：攻略推文、美食酒店调研（点评网站）
地图上规划指的是：需要地图信息（例如离当前最近的目的地，距离景点最近的酒店，如何从当前位置到目的地）

用户问题：{query}

请直接回答"静态攻略"或"地图上规划"或"静态攻略, 地图上规划"。"""
            
            # 最多重试3次
            success = False
            for attempt in range(3):
                response = get_openai_response(prompt, api_key, model_name)
                
                # 检查是否为错误响应
                if response.startswith("Error:"):
                    print(f"API调用错误: {response}")
                    continue
                
                # 检查响应是否有效
                if is_valid_response(response):
                    # 构建数据格式
                    data_entry = {
                        "system": "",
                        "prompt": prompt,
                        "response": response.strip()
                    }
                    
                    # 写入文件
                    f.write(json.dumps(data_entry, ensure_ascii=False) + '\n')
                    f.flush()  # 确保立即写入
                    success = True
                    break
                else:
                    print(f"无效响应 (尝试 {attempt + 1}/3): {response}")
            
            if not success:
                print(f"跳过查询: {query}")

# 配置参数
model_name = "gpt-4o"
# api_key = "sk-8uZDRBjjuuwpdArZWdCpo7EP2iKhXBHBnvS5x2ajUbWr8u6t"
api_key = "sk-kxHck7UPIZVBi4TP3d13366b45F24aC1B50a5dB3DaA100Fb"
output_file = "data/任务路由.jsonl"

queries = [
    "北京有哪些必去的景点？",
    "从首都机场到天安门最快的路线是什么？",
    "北京最好的烤鸭店在哪里？",
    "离故宫最近的地铁站是哪个？",
    "北京三日游攻略推荐",
    "从王府井到长城怎么走？",
    "北京有什么特色小吃？",
    "距离西二旗最近的景点是什么？",
    "798艺术区有哪些值得看的展览？",
    "三里屯附近有什么好吃的餐厅推荐？",
    "中国国家博物馆需要提前预约吗？",
    "什刹海租船多少钱一小时？",
    "八达岭长城最佳观景点在哪里？",
    "前门大街晚上好玩吗？",
    "北京大学校园可以自由参观吗？",
    "北京CBD附近的高档酒店有哪些？",
    "北京东城区有什么特色餐厅？",
    "丰台区周末适合去哪玩？",
    "北京使馆区有哪些异国餐厅？",
    "北京动物园看大熊猫的最佳时间是什么时候？",
    "北京后海晚上有什么活动？",
    "大兴区有哪些亲子游景点？",
    "北京奥林匹克公园夜景好看吗？",
    "密云区秋天适合去哪玩？",
    "延庆区冬天滑雪推荐哪里？",
    "怀柔区哪些地方适合露营？",
    "昌平区除了十三陵还有什么好玩的？",
    "朝阳区哪里有好逛的商场？",
    "首都机场周边有什么酒店推荐？",
    "北京欢乐谷门票多少钱？",
    "海淀区有什么好吃的餐馆？",
    "石景山区有什么特色景点？",
    "北京老城区适合citywalk的路线有哪些？",
    "北京胡同区适合拍照的地方有哪些？",
    "西城区周末适合去哪？",
    "通州区有什么好玩的地方？",
    "北京郊区自驾一日游路线推荐",
    "顺义区有哪些采摘园？",
    "十三陵景区需要预约吗？",
    "北京环球影城有哪些热门项目？",
    "北海公园荷花季什么时候？",
    "南锣鼓巷附近有什么特色小吃？",
    "国家大剧院有什么演出推荐？",
    "圆明园的最佳游览路线是什么？",
    "天坛公园适合晨练吗？",
    "天安门广场升旗仪式几点开始？",
    "奥体中心附近有什么酒店？",
    "慕田峪长城人多吗？",
    "景山公园看故宫全景的机位在哪？",
    "水立方晚上会亮灯吗？",
    "王府井步行街营业到几点？",
    "簋街晚上几点最热闹？",
    "长城秋天去合适吗？",
    "雍和宫求签灵吗？",
    "颐和园划船多少钱？",
    "鸟巢可以进去参观吗？",
    "清华大学需要预约参观吗？",
    "中国人民大学附近有什么餐馆？",
    "北京航空航天大学校园景色怎么样？",
    "北京师范大学的图书馆可以外借吗？",
    "北京理工大学周边有什么好吃的？",
    "中国农业大学周末开放吗？",
    "中央民族大学的民族文化展在哪里？",
    "北京交通大学附近的美食街叫什么？",
    "北京科技大学有什么特色活动？",
    "北京外国语大学的语言博物馆对外开放吗？",
    "中国政法大学附近的地铁站是哪个？",
    "798艺术区附近的咖啡厅推荐",
    "三里屯夜生活怎么玩？",
    "中国国家博物馆展览时间表",
    "什刹海冰场什么时候开放？",
    "八达岭长城缆车票价多少？",
    "前门大街有哪些老字号？",
    "北京大学附近的书店推荐",
    "北京CBD拍夜景的好地方",
    "北京东城区胡同游推荐",
    "丰台区周末市集在哪？",
    "北京使馆区最美的街道是哪条？",
    "北京动物园门票价格",
    "北京后海酒吧街怎么样？",
    "大兴区适合带孩子的餐厅",
    "北京奥林匹克公园适合跑步吗？",
    "密云区水库可以钓鱼吗？",
    "延庆区夏天避暑推荐",
    "怀柔区山里民宿推荐",
    "昌平区地铁沿线景点",
    "朝阳区哪里有好玩的亲子乐园？",
    "首都机场到市区的地铁路线",
    "北京欢乐谷适合情侣玩吗？",
    "海淀区适合学习的咖啡馆",
    "石景山区爬山的地方",
    "北京老城区的摄影机位",
    "北京胡同区的美食地图",
    "西城区最好的早餐店",
    "通州区运河公园好玩吗？",
    "北京郊区露营地推荐",
    "顺义区周末自驾路线",
    "十三陵附近的餐厅推荐",
    "北京环球影城门票价格",
    "北海公园冬天好玩吗？",
    "南锣鼓巷人多吗？",
    "国家大剧院内部参观需要票吗？",
    "圆明园拍照最佳季节",
    "天坛拍日出的好位置",
    "天安门广场附近的酒店推荐",
    "奥体中心看比赛的最佳位置",
    "慕田峪长城徒步路线",
    "景山公园樱花开花时间",
    "水立方内部有什么？",
    "王府井可以买到哪些特产？",
    "簋街有素食餐厅吗？",
    "长城夜游项目有吗？",
    "雍和宫附近的茶馆推荐",
    "颐和园冬天有活动吗？",
    "鸟巢举办过哪些大赛？",
    "清华大学周边住宿推荐",
    "中国人民大学校园参观预约",
    "北京航空航天大学博物馆开放时间",
    "北京师范大学附近的早餐店",
    "北京理工大学的校园特色",
    "中国农业大学的农场开放吗？",
    "中央民族大学美食推荐",
    "北京交通大学周边住宿",
    "北京科技大学图书馆开放时间",
    "北京外国语大学校园地图",
    "中国政法大学的历史介绍",
    "798艺术区最受欢迎的展馆",
    "三里屯的最佳拍照点",
    "中国国家博物馆镇馆之宝有哪些？",
    "什刹海夏天怎么玩？",
    "八达岭长城最佳拍摄时间",
    "前门大街交通攻略",
    "北京大学的历史建筑有哪些？",
    "北京CBD停车方便吗？",
    "北京东城区的文化活动",
    "丰台区最火的餐厅",
    "北京使馆区的咖啡厅推荐",
    "北京动物园儿童票价",
    "北京后海白天好玩吗？",
    "大兴区的历史景点有哪些？",
    "北京奥林匹克公园拍照机位",
    "密云区的红叶观赏点",
    "延庆区的农家乐推荐",
    "怀柔区的漂流地点",
    "昌平区的温泉酒店",
    "朝阳区的艺术展览",
    "首都机场到北京南站怎么走？",
    "北京欢乐谷夜场活动",
    "海淀区的二手书店",
    "石景山区的特色美食",
    "北京老城区的手工艺品店",
    "北京胡同区的文化体验",
    "西城区的老字号餐厅",
    "通州区的夜景拍摄点",
    "北京郊区的滑雪场",
    "顺义区的温泉度假村",
    "十三陵的开放时间",
    "北京环球影城表演时间",
    "北海公园划船价格",
    "南锣鼓巷的文创店",
    "国家大剧院的建筑亮点",
    "圆明园的历史故事",
    "天坛的祭天大典介绍",
    "天安门广场看升旗攻略",
    "奥体中心的演唱会场地",
    "慕田峪长城索道信息",
    "景山公园门票价格",
    "水立方举办过的活动",
    "王府井的美食推荐",
    "簋街的营业时间",
    "长城的旅游季节",
    "雍和宫的开放时间",
    "颐和园的游船路线",
    "鸟巢的开放时间",
    "清华大学的著名教授",
    "中国人民大学的优势学科",
    "北京航空航天大学的专业特色",
    "北京师范大学的校园文化",
    "北京理工大学的科研成果",
    "中国农业大学的植物园",
    "中央民族大学的民族节日",
    "北京交通大学的历史沿革",
    "北京科技大学的校园环境",
    "北京外国语大学的外籍学生情况",
    "中国政法大学的著名校友",
    "从北京南站到颐和园坐地铁怎么走？",
    "从天安门广场到北京欢乐谷需要多长时间？",
    "故宫附近最近的停车场在哪里？",
    "从王府井到八达岭长城的自驾路线怎么走？",
    "长城脚下的民宿有哪些推荐？",
    "从北京首都机场到三里屯最快的地铁路线是什么？",
    "北京西站到鸟巢的公交路线有哪些？",
    "颐和园附近有哪些高评分餐馆？",
    "地铁4号线沿线有哪些景点值得一去？",
    "北京站到中国国家博物馆步行要多久？",
    "北京动物园附近的酒店有哪些？",
    "西单到圆明园的换乘方案是什么？",
    "地铁2号线可以直达哪些热门旅游景点？",
    "从国贸到798艺术区最好怎么走？",
    "北京地铁哪几条线可以到达天坛公园？",
    "北京南站附近的商务酒店有哪些？",
    "从北京西站到香山公园的公交路线推荐",
    "南锣鼓巷附近的地铁站是哪个？",
    "北京地铁1号线沿线的景点有哪些？",
    "从望京到奥林匹克公园骑行需要多久？",
    "北京环球影城附近的住宿推荐",
    "地铁5号线沿线有哪些著名景点？",
    "从首都机场到北海公园打车需要多久？",
    "什刹海附近的咖啡厅集中在哪些街道？",
    "北京站到雍和宫的地铁换乘方式",
    "地铁10号线沿线的美食街推荐",
    "北京欢乐谷附近的地铁站是哪个？",
    "北京西站到天安门广场的最佳出行方式",
    "鸟巢附近的停车场分布在哪里？",
    "朝阳公园周边的餐饮选择有哪些？",
    "北京地铁14号线经过哪些景点？",
    "奥体中心附近的快捷酒店推荐",
    "从北京南站到密云水库的自驾路线",
    "地铁6号线沿线的文化景点有哪些？",
    "北京动物园到北京植物园的公交路线",
    "从前门到颐和园的地铁乘坐方案",
    "798艺术区附近的精品酒店",
    "北京地铁8号线沿线的旅游景点",
    "天坛公园周边的早餐店推荐",
    "北京西站到长城的旅游巴士在哪里乘坐？",
    "地铁7号线沿线的特色餐厅",
    "北京站到香山公园的公交换乘方案",
    "北京CBD附近的地铁站分布",
    "从首都机场到五道口的最快路线",
    "北海公园周边的宾馆推荐",
    "北京地铁13号线沿线的景点",
    "地铁4号线从动物园到清华大学的时间",
    "北京西单到三里屯的地铁路线",
    "从北京南站到延庆滑雪场怎么走？",
    "北京站到天坛的步行路线",
    "北京地铁昌平线沿线好玩的地方",
    "从国贸到故宫最佳出行方式",
    "地铁1号线经过的购物中心有哪些？",
    "北京南站附近的快餐店推荐",
    "朝阳区的地铁站旁有哪些景点？",
    "北京西站到颐和园的骑行路线",
    "798艺术区到国家大剧院的地铁换乘",
    "北京站到大兴机场的最快交通方式",
    "天安门附近的连锁酒店",
    "地铁5号线从雍和宫到宋家庄的景点分布",
    "北京地铁房山线沿线的旅游资源",
    "从首都机场到八达岭长城的高铁路线",
    "北京西站到南锣鼓巷的地铁路线",
    "怀柔雁栖湖附近的住宿选择",
    "北京站到王府井的公交线路",
    "北京南站到水立方的最佳路线",
    "北京地铁2号线沿线的老城区景点",
    "鸟巢到颐和园的地铁方案",
    "北京地铁15号线沿线的景点",
    "北京西站到十三陵的旅游巴士",
    "环球影城到天安门的出行方案",
    "地铁1号线从四惠到苹果园的沿途景点",
    "北京站到北京欢乐谷的最佳方式",
    "王府井附近的地铁站出口分布",
    "北京南站到圆明园的地铁方案",
    "北京地铁昌平线到八达岭的换乘方式",
    "798艺术区到北京动物园的出行路线",
    "北京地铁10号线环线的主要景点",
    "地铁14号线到环球影城的路线",
    "北京西站到北海公园的地铁方案",
    "从国贸到香山公园的交通方式",
    "北京站到鸟巢的最快路线",
    "地铁5号线沿线的美食街区",
    "北京南站到南锣鼓巷的地铁方案",
    "北京地铁6号线沿线的博物馆",
    "地铁8号线到奥林匹克公园的出口",
    "北京西站到798艺术区的公交方案",
    "首都机场到王府井的最佳路线",
    "北京站到颐和园的地铁方案",
    "北京南站到故宫的最快方式",
    "地铁13号线沿线的餐饮推荐",
    "北京地铁亦庄线沿线的景点",
    "北京西站到天坛的地铁方案",
    "北京站到北海公园的出行方式",
    "地铁房山线到北京野生动物园的路线",
    "北京南站到环球影城的地铁方案",
    "北京地铁8号线沿线的餐厅推荐",
    "地铁4号线到北京动物园的出口",
    "北京西站到五道口的地铁路线",
    "798艺术区到三里屯的出行方式",
    "北京地铁10号线沿线的购物中心",
    "北京南站到八达岭长城的交通方式",
    "北京站到雍和宫的最快路线"
]

# 开始处理
print(f"开始处理 {len(queries)} 个查询...")
process_queries(queries, api_key, model_name, output_file)
print(f"处理完成！结果已保存到 {output_file}")